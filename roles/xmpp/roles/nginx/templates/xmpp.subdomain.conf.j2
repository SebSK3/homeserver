map $http_upgrade $connection_upgrade{
    default upgrade;
    `` close;
}

server {
    listen 80 default_server;
    {% include "templates/common/params.j2" %}
    server_name xmpp.{{ host }};
}
server {
    {% include "templates/common/public.j2" %}
    {% include "templates/common/params.j2" %}

    {% include "templates/common/ssl.j2" %}

    server_name xmpp.{{ host }};

    location =/.well-known/host-meta {
        alias /var/www/html/host-meta;
    }
    location =/.well-known/host-meta.json {
        alias /var/www/html/host-meta.json;
    }
    #location / {
    #    return 403;
    #}
    location /slidge {
        alias /var/lib/slidge/attachments/;
    }
    location /xmpp-websocket {
        include /etc/nginx/proxy.conf;

        set $upstream_app 127.0.0.1;
        set $upstream_port 5280;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port/xmpp-websocket;
    }
    location /file_share {
        include /etc/nginx/proxy.conf;

        set $upstream_app 127.0.0.1;
        set $upstream_port 5280;
        set $upstream_proto http;
        proxy_pass $upstream_proto://$upstream_app:$upstream_port$request_uri;
    }
}
